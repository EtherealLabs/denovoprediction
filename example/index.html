<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Conformation Sampling</title>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="http://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
    <style>
        .mol-container {
          width: 60%;
          height: 400px;
          position: relative;
        }
    </style>
</head>
<body>
    <form id="seqform" action="/gen" method="post">
        <label class="control-label" for="sequence">Sequence</label>
        <select id="sequence" name="sequence">
              <option value="casp10_t0678">CASP10 T0678 APC100075</option>
              <option value="casp10_t0651">CASP10 T0651 LGR82</option>
              <option value="casp10_t0694">CASP10 T0694 UP20725R</option>
              <option value="casp10_t0757">CASP10 T0757 APC103790</option>
              <option value="casp10_t0666">CASP10 T0666 UCI BBCS</option>
              <option value="casp11_t0837">CASP11 T0837 YPO2654</option>
              <option value="casp11_t0792">CASP11 T0792 Oskar-N</option>
              <option value="casp11_t0806">CASP11 T0806 YaaA</option>
              <option value="casp11_t0843">CASP11 T0843 Ats13</option>
              <option value="casp11_t0856">CASP11 T0856 HERC1</option>
        </select>
        <button type="submit" class="btn"> Begin </button>
    </form>
    <div id="container-01" class="mol-container"></div>
    <script>
    let start = false;
    let element = $('#container-01');
    let config = { backgroundColor: 'orange' };
    let viewer = $3Dmol.createViewer( element, config );
    let complete = false;

    $('#seqform').submit(function(e){
        e.preventDefault();
        $.ajax({
            url:'/gen',
            type:'post',
            data:$('#seqform').serialize(),
            success:function(response){
                start = true;
                console.log(response);
            }
        });
    });

    poll = function() {
        console.log("polling");
        url = '/gen/complete'
        jQuery.ajax(url, {
            success: function(data) {
                generate();
                complete = data['complete'];
                if(complete === true) {
                    console.log("server finished processing");
                }
            },
            error: function(hdr, status, err) {
                console.error("couldn't find out if we should continue");
            }
        });
    }

    get_pdb = function() {
        url = '/gen/current'
        jQuery.ajax(url, {
            success: function(data) {
                return data;
            },
            error: function(hdr, status, err) {
                console.error("couldn't get the pdb");

            }
        });
    }

    generate = function() {
        console.log("asking for PDB");
        let v = viewer;
        let pdbUri = '/gen/current';
        jQuery.ajax( pdbUri, {
            success: function(data) {
                console.log(data);
                if(data.status === '202') {
                    console.log("not yet ready");
                    return;
                }
                v.addModel(data, "pdb");
                v.setStyle({}, {cartoon: {color: 'spectrum'}});  /* style all atoms */
                v.zoomTo();                                      /* set camera */
                v.render();                                      /* render scene */
                v.zoom(1.2, 1000);                               /* slight zoom */
            },
            error: function(resp) {
                console.log("failed to get response");
                console.log(resp);
            }
        });
    }

    setInterval(function(){ console.log(complete); if(!complete && start) {poll();} }, 10000);
    </script>
</body>
</html>
